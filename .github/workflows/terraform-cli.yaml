name: Terraform CLI
run-name: Terraform ${{ inputs.command }} in ${{ inputs.working_directory }}

on:
  workflow_dispatch:
    inputs:
      working_directory:
        description: "Terraform working directory (e.g., terraform/karpenter-experiment or terraform/environments/staging/3-eks)"
        required: true
        type: string
      command:
        description: "Terraform command to run"
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
          - plan -destroy
      auto_approve:
        description: "Auto-approve (for apply/destroy commands)"
        required: true
        type: boolean
        default: false
      additional_args:
        description: "Additional terraform arguments (optional)"
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ inputs.working_directory }}-${{ inputs.command }}
  cancel-in-progress: false

jobs:
  terraform-cli:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for OIDC
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_TERRAFORM_ROLE_ARN }}
          aws-region: ap-southeast-1

      - name: HashiCorp - Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2

      - name: Terraform Init
        working-directory: ${{ inputs.working_directory }}
        run: terraform init

      - name: Terraform ${{ inputs.command }}
        working-directory: ${{ inputs.working_directory }}
        run: |
          COMMAND="${{ inputs.command }}"
          ADDITIONAL_ARGS="${{ inputs.additional_args }}"

          if [ "${{ inputs.auto_approve }}" = "true" ] && [[ "$COMMAND" == "apply" || "$COMMAND" == "destroy" ]]; then
            echo "Running: terraform $COMMAND -auto-approve $ADDITIONAL_ARGS"
            terraform $COMMAND -auto-approve $ADDITIONAL_ARGS
          else
            echo "Running: terraform $COMMAND $ADDITIONAL_ARGS"
            terraform $COMMAND $ADDITIONAL_ARGS
          fi

      - name: Summary
        if: always()
        run: |
          echo "### Terraform Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Working Directory**: \`${{ inputs.working_directory }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Command**: \`terraform ${{ inputs.command }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto-approve**: ${{ inputs.auto_approve }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Additional Args**: \`${{ inputs.additional_args }}\`" >> $GITHUB_STEP_SUMMARY
