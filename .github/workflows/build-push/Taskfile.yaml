version: "3"

env:
  ACT_CONTAINER_ARCH: linux/arm64
  ACT_PLATFORM: ubuntu-latest=catthehacker/ubuntu:act-latest
  ACT_BASE_CMD: |
    act \
      --container-architecture {{.ACT_CONTAINER_ARCH}} \
      --platform {{.ACT_PLATFORM}} \
      --directory ../../../ \
      --workflows .github/workflows/build-push.yaml \
      --cache-server-path ~/.cache/act

tasks:
  # Tag-based triggers (production builds)
  trigger-tag-golang:
    desc: "Test tag event for Go service (production)"
    cmds:
      - |
        act push \
          --container-architecture {{.ACT_CONTAINER_ARCH}} \
          --platform {{.ACT_PLATFORM}} \
          --eventpath {{.PWD}}/tag.json \
          --directory ../../../ \
          --workflows .github/workflows/build-push.yaml \
          --cache-server-path ~/.cache/act

  trigger-tag-node:
    desc: "Test tag event for Node service (production)"
    cmds:
      - |
        act push \
          --container-architecture {{.ACT_CONTAINER_ARCH}} \
          --platform {{.ACT_PLATFORM}} \
          --eventpath {{.PWD}}/tag-node.json \
          --directory ../../../ \
          --workflows .github/workflows/build-push.yaml \
          --cache-server-path ~/.cache/act

  trigger-tag-python:
    desc: "Test tag event for Python service (production)"
    cmds:
      - |
        act push \
          --container-architecture {{.ACT_CONTAINER_ARCH}} \
          --platform {{.ACT_PLATFORM}} \
          --eventpath {{.PWD}}/tag-python.json \
          --directory ../../../ \
          --workflows .github/workflows/build-push.yaml \
          --cache-server-path ~/.cache/act

  # Workflow dispatch triggers (manual builds)
  trigger-manual-with-version:
    desc: "Test manual trigger with explicit version"
    cmds:
      - |
        act workflow_dispatch \
          --container-architecture {{.ACT_CONTAINER_ARCH}} \
          --platform {{.ACT_PLATFORM}} \
          --eventpath {{.PWD}}/workflow-dispatch.json \
          --directory ../../../ \
          --workflows .github/workflows/build-push.yaml \
          --cache-server-path ~/.cache/act

  trigger-manual-no-version:
    desc: "Test manual trigger with auto-generated version"
    cmds:
      - |
        act workflow_dispatch \
          --container-architecture {{.ACT_CONTAINER_ARCH}} \
          --platform {{.ACT_PLATFORM}} \
          --eventpath {{.PWD}}/workflow-dispatch-no-version.json \
          --directory ../../../ \
          --workflows .github/workflows/build-push.yaml \
          --cache-server-path ~/.cache/act

  # Push to main branch trigger (staging builds)
  trigger-push-main:
    desc: "Test push to main with service changes (staging)"
    cmds:
      - |
        act push \
          --container-architecture {{.ACT_CONTAINER_ARCH}} \
          --platform {{.ACT_PLATFORM}} \
          --eventpath {{.PWD}}/push-main.json \
          --directory ../../../ \
          --workflows .github/workflows/build-push.yaml \
          --cache-server-path ~/.cache/act

  # Run all tests
  test-all:
    desc: "Run all test scenarios"
    cmds:
      - echo "=== Testing Tag Events (Production) ==="
      - task: trigger-tag-golang
      - echo ""
      - echo "=== Testing Manual Trigger with Version ==="
      - task: trigger-manual-with-version
      - echo ""
      - echo "=== Testing Manual Trigger without Version ==="
      - task: trigger-manual-no-version
      - echo ""
      - echo "=== Testing Push to Main (Staging) ==="
      - task: trigger-push-main
      - echo ""
      - echo "All tests completed!"

  # Individual test categories
  test-tags:
    desc: "Test all tag-based triggers"
    cmds:
      - echo "=== Testing Go Service Tag ==="
      - task: trigger-tag-golang
      - echo ""
      - echo "=== Testing Node Service Tag ==="
      - task: trigger-tag-node
      - echo ""
      - echo "=== Testing Python Service Tag ==="
      - task: trigger-tag-python

  test-manual:
    desc: "Test all manual triggers"
    cmds:
      - echo "=== Testing with explicit version ==="
      - task: trigger-manual-with-version
      - echo ""
      - echo "=== Testing with auto-generated version ==="
      - task: trigger-manual-no-version
