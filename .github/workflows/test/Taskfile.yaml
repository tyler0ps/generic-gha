version: "3"

vars:
  ACT_CONTAINER_ARCH: linux/arm64
  ACT_CACHE_PATH: ~/.cache/act
  REPO_ROOT: ../../../
  WORKFLOW_PATH: .github/workflows/test.yaml
  ACT_PLATFORM: ubuntu-latest=catthehacker/ubuntu:act-latest

tasks:
  default:
    desc: "Run all service tests"
    cmds:
      - task: test:all

  test:all:
    desc: "Run unit tests for all services"
    cmds:
      - |
        act workflow_dispatch \
          --container-architecture {{.ACT_CONTAINER_ARCH}} \
          --platform {{.ACT_PLATFORM}} \
          --eventpath {{.PWD}}/event-all.json \
          --directory {{.REPO_ROOT}} \
          --workflows {{.WORKFLOW_PATH}} \
          --cache-server-path {{.ACT_CACHE_PATH}}

  test:api-golang:
    desc: "Run unit tests for Go API service"
    cmds:
      - |
        act workflow_dispatch \
          --container-architecture {{.ACT_CONTAINER_ARCH}} \
          --platform {{.ACT_PLATFORM}} \
          --eventpath {{.PWD}}/event-api-golang.json \
          --directory {{.REPO_ROOT}} \
          --workflows {{.WORKFLOW_PATH}} \
          --cache-server-path {{.ACT_CACHE_PATH}}

  test:api-node:
    desc: "Run unit tests for Node API service"
    cmds:
      - |
        act workflow_dispatch \
          --container-architecture {{.ACT_CONTAINER_ARCH}} \
          --platform {{.ACT_PLATFORM}} \
          --eventpath {{.PWD}}/event-api-node.json \
          --directory {{.REPO_ROOT}} \
          --workflows {{.WORKFLOW_PATH}} \
          --cache-server-path {{.ACT_CACHE_PATH}}

  test:client-react:
    desc: "Run unit tests for React client service"
    cmds:
      - |
        act workflow_dispatch \
          --container-architecture {{.ACT_CONTAINER_ARCH}} \
          --platform {{.ACT_PLATFORM}} \
          --eventpath {{.PWD}}/event-client-react.json \
          --directory {{.REPO_ROOT}} \
          --workflows {{.WORKFLOW_PATH}} \
          --cache-server-path {{.ACT_CACHE_PATH}}

  test:load-generator-python:
    desc: "Run unit tests for Python load generator service"
    cmds:
      - |
        act workflow_dispatch \
          --container-architecture {{.ACT_CONTAINER_ARCH}} \
          --platform {{.ACT_PLATFORM}} \
          --eventpath {{.PWD}}/event-load-generator-python.json \
          --directory {{.REPO_ROOT}} \
          --workflows {{.WORKFLOW_PATH}} \
          --cache-server-path {{.ACT_CACHE_PATH}}

  test:api-golang-migrator:
    desc: "Run unit tests for API Golang migrator service"
    cmds:
      - |
        act workflow_dispatch \
          --container-architecture {{.ACT_CONTAINER_ARCH}} \
          --platform {{.ACT_PLATFORM}} \
          --eventpath {{.PWD}}/event-api-golang-migrator.json \
          --directory {{.REPO_ROOT}} \
          --workflows {{.WORKFLOW_PATH}} \
          --cache-server-path {{.ACT_CACHE_PATH}}
