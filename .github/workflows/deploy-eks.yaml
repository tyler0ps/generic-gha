name: Deploy to EKS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        type: choice
        options:
          - staging
        default: staging
      service:
        description: "Service to deploy (leave empty for all)"
        required: false
        type: choice
        options:
          - all
          - api-golang
          - api-node
          - client-react
        default: all
      action:
        description: "Deployment action"
        required: true
        type: choice
        options:
          - apply
          - delete
          - status
        default: apply

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_TERRAFORM_ROLE_ARN }}
          aws-region: ap-southeast-1

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.31.0'

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name ${{ inputs.environment }}-generic-gha \
            --region ap-southeast-1

      - name: Verify cluster access
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy Karpenter Provisioner
        if: inputs.action == 'apply'
        run: |
          echo "Applying Karpenter provisioner..."
          kubectl apply -f deploy/kubernetes/${{ inputs.environment }}/karpenter/provisioner.yaml

      - name: Create namespace
        if: inputs.action == 'apply'
        run: |
          kubectl apply -f deploy/kubernetes/${{ inputs.environment }}/namespace.yaml

      - name: Create database secret (manual step)
        if: inputs.action == 'apply'
        run: |
          echo "⚠️  MANUAL STEP REQUIRED:"
          echo "Create database credentials secret with:"
          echo ""
          echo "DB_URL=\$(aws ssm get-parameter --name /${{ inputs.environment }}/postgres/db-connection-string --with-decryption --query 'Parameter.Value' --output text)"
          echo "kubectl create secret generic database-credentials --namespace=${{ inputs.environment }} --from-literal=connection-string=\"\$DB_URL\" --dry-run=client -o yaml | kubectl apply -f -"
          echo ""
          echo "Checking if secret exists..."
          if kubectl get secret database-credentials -n ${{ inputs.environment }} &> /dev/null; then
            echo "✅ Secret database-credentials already exists"
          else
            echo "⚠️  Secret database-credentials does not exist - creating it now..."
            DB_URL=$(aws ssm get-parameter --name /${{ inputs.environment }}/postgres/db-connection-string --with-decryption --query 'Parameter.Value' --output text)
            kubectl create secret generic database-credentials \
              --namespace=${{ inputs.environment }} \
              --from-literal=connection-string="$DB_URL"
            echo "✅ Secret created"
          fi

      - name: Deploy all services
        if: inputs.action == 'apply' && inputs.service == 'all'
        run: |
          echo "Deploying all services..."

          # Deploy services
          kubectl apply -f deploy/kubernetes/${{ inputs.environment }}/services/api-golang/
          kubectl apply -f deploy/kubernetes/${{ inputs.environment }}/services/api-node/
          kubectl apply -f deploy/kubernetes/${{ inputs.environment }}/services/client-react/

          # Deploy ingress
          kubectl apply -f deploy/kubernetes/${{ inputs.environment }}/ingress/

          # Deploy scheduled scaling
          kubectl apply -f deploy/kubernetes/${{ inputs.environment }}/schedules/

          echo "✅ All services deployed"

      - name: Deploy specific service
        if: inputs.action == 'apply' && inputs.service != 'all'
        run: |
          echo "Deploying ${{ inputs.service }}..."
          kubectl apply -f deploy/kubernetes/${{ inputs.environment }}/services/${{ inputs.service }}/
          echo "✅ Service deployed"

      - name: Wait for deployments to be ready
        if: inputs.action == 'apply'
        run: |
          echo "Waiting for deployments to be ready..."
          if [ "${{ inputs.service }}" == "all" ]; then
            kubectl wait --for=condition=available --timeout=300s \
              deployment/api-golang deployment/api-node deployment/client-react \
              -n ${{ inputs.environment }}
          else
            kubectl wait --for=condition=available --timeout=300s \
              deployment/${{ inputs.service }} \
              -n ${{ inputs.environment }}
          fi
          echo "✅ Deployments ready"

      - name: Get deployment status
        if: inputs.action == 'status' || inputs.action == 'apply'
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployments -n ${{ inputs.environment }}
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n ${{ inputs.environment }}
          echo ""
          echo "=== Services ==="
          kubectl get services -n ${{ inputs.environment }}
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress -n ${{ inputs.environment }}
          echo ""
          echo "=== Nodes ==="
          kubectl get nodes -o wide

      - name: Get ALB URL
        if: inputs.action == 'apply'
        run: |
          echo "Waiting for ALB to be provisioned..."
          sleep 30
          ALB_URL=$(kubectl get ingress main-ingress -n ${{ inputs.environment }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          if [ -n "$ALB_URL" ]; then
            echo "✅ ALB URL: http://$ALB_URL"
            echo ""
            echo "Test endpoints:"
            echo "  - Frontend:    http://$ALB_URL/"
            echo "  - Go API:      http://$ALB_URL/api/golang/"
            echo "  - Node API:    http://$ALB_URL/api/node/"
          else
            echo "⚠️  ALB not ready yet. Check status with: kubectl get ingress -n ${{ inputs.environment }}"
          fi

      - name: Delete resources
        if: inputs.action == 'delete'
        run: |
          echo "Deleting resources from ${{ inputs.environment }}..."
          kubectl delete -f deploy/kubernetes/${{ inputs.environment }}/services/ --ignore-not-found=true
          kubectl delete -f deploy/kubernetes/${{ inputs.environment }}/ingress/ --ignore-not-found=true
          kubectl delete -f deploy/kubernetes/${{ inputs.environment }}/schedules/ --ignore-not-found=true
          kubectl delete -f deploy/kubernetes/${{ inputs.environment }}/karpenter/ --ignore-not-found=true
          echo "✅ Resources deleted"

      - name: Run database migration
        if: inputs.action == 'apply' && inputs.service == 'all'
        run: |
          echo "Running database migration..."
          kubectl apply -f deploy/kubernetes/${{ inputs.environment }}/jobs/db-migrator.yaml

          # Wait for job to complete
          kubectl wait --for=condition=complete --timeout=300s job/db-migrator -n ${{ inputs.environment }} || true

          # Show migration logs
          kubectl logs job/db-migrator -n ${{ inputs.environment }} || echo "Migration job not ready yet"

          echo "✅ Database migration completed"
