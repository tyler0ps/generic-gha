name: Run Tests
on:
  workflow_dispatch:
    inputs:
      service:
        description: "Select a service to test"
        required: false
        type: choice
        default: "all"
        options:
          - all
          - services/go/api-golang
          - services/node/api-node
          - services/python/load-generator-python
          - services/react/client-react
          - services/other/api-golang-migrator
  push:
    branches:
      - main
    paths:
      - services/**
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      services: ${{ steps.set-services.outputs.services }}
    steps:
      - uses: actions/checkout@v6
      - name: Filter changed paths
        if: github.event_name != 'workflow_dispatch'
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: .github/utils/file-filters.yaml
      - name: Set services matrix
        id: set-services
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.service }}" = "all" ] || [ -z "${{ github.event.inputs.service }}" ]; then
              echo 'services=["services/go/api-golang","services/node/api-node","services/react/client-react","services/python/load-generator-python","services/other/api-golang-migrator"]' >> $GITHUB_OUTPUT
            else
              echo 'services=["${{ github.event.inputs.service }}"]' >> $GITHUB_OUTPUT
            fi
          else
            echo 'services=${{ steps.filter.outputs.changes }}' >> $GITHUB_OUTPUT
          fi

  unit-test:
    runs-on: ubuntu-latest
    needs: changes
    strategy:
      matrix:
        service: ${{ fromJson(needs.changes.outputs.services) }}
    steps:
      - uses: actions/checkout@v6
      - name: Setup Dependencies
        uses: ./.github/actions/setup-dependencies
        with:
          install_task: "true"
          install_go: ${{ startsWith(matrix.service, 'services/go') }}
          install_node: ${{ startsWith(matrix.service, 'services/node') || startsWith(matrix.service, 'services/react') }}
          install_python: ${{ startsWith(matrix.service, 'services/python') }}
          service_path: ${{ matrix.service }}
      - name: Install Dependency
        working-directory: ${{ matrix.service }}
        run: |
          task install-ci
      - name: Run Test
        working-directory: ${{ matrix.service }}
        run: |
          task test
