name: Test OIDC Authentication

on:
  workflow_dispatch:

jobs:
  test-ecr-role:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ECR_ROLE_ARN }}
          aws-region: ap-southeast-1

      - name: Test ECR Login
        run: |
          echo "Testing ECR authentication..."
          aws ecr get-login-password --region ap-southeast-1 | \
            docker login --username AWS --password-stdin \
            $(aws sts get-caller-identity --query Account --output text).dkr.ecr.ap-southeast-1.amazonaws.com
          echo "✅ SUCCESS: ECR authentication works!"

      - name: Verify Assumed Role
        run: |
          echo "Current AWS Identity:"
          aws sts get-caller-identity
          echo ""
          echo "Assumed Role ARN:"
          aws sts get-caller-identity --query Arn --output text

  test-terraform-role:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_TERRAFORM_ROLE_ARN }}
          aws-region: ap-southeast-1

      - name: Test S3 State Access
        run: |
          echo "Testing S3 state bucket access..."
          aws s3 ls s3://generic-gha-terraform-state/
          echo "✅ SUCCESS: S3 state access works!"

      - name: Test EC2 Permissions
        run: |
          echo "Testing EC2 permissions..."
          aws ec2 describe-vpcs --region ap-southeast-1
          echo "✅ SUCCESS: EC2 permissions work!"

      - name: Verify Assumed Role
        run: |
          echo "Current AWS Identity:"
          aws sts get-caller-identity
          echo ""
          echo "Assumed Role ARN:"
          aws sts get-caller-identity --query Arn --output text
