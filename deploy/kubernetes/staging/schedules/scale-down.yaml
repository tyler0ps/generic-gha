# Scheduled Scaling for Cost Optimization
# Scales down services during off-hours to save ~70% on compute costs

---
# Scale down on weeknights (10 PM)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: scale-down-weeknight
  namespace: staging
  labels:
    app: scaler
    type: scale-down
spec:
  schedule: "0 22 * * 1-5"  # 10 PM Monday-Friday (SGT timezone)
  timeZone: "Asia/Singapore"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: scaler
          restartPolicy: OnFailure
          containers:
          - name: kubectl
            image: bitnami/kubectl:latest
            command:
            - /bin/sh
            - -c
            - |
              echo "Scaling down services for the night..."
              kubectl scale deployment/api-golang --replicas=0 -n staging
              kubectl scale deployment/api-node --replicas=0 -n staging
              kubectl scale deployment/client-react --replicas=0 -n staging
              echo "Services scaled down successfully"

---
# Scale up on weekday mornings (8 AM)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: scale-up-weekday
  namespace: staging
  labels:
    app: scaler
    type: scale-up
spec:
  schedule: "0 8 * * 1-5"  # 8 AM Monday-Friday (SGT timezone)
  timeZone: "Asia/Singapore"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: scaler
          restartPolicy: OnFailure
          containers:
          - name: kubectl
            image: bitnami/kubectl:latest
            command:
            - /bin/sh
            - -c
            - |
              echo "Scaling up services for the workday..."
              kubectl scale deployment/api-golang --replicas=1 -n staging
              kubectl scale deployment/api-node --replicas=1 -n staging
              kubectl scale deployment/client-react --replicas=1 -n staging
              echo "Services scaled up successfully"

---
# Scale down on Friday night (10 PM) for the weekend
apiVersion: batch/v1
kind: CronJob
metadata:
  name: scale-down-weekend
  namespace: staging
  labels:
    app: scaler
    type: scale-down
spec:
  schedule: "0 22 * * 5"  # 10 PM Friday (SGT timezone)
  timeZone: "Asia/Singapore"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: scaler
          restartPolicy: OnFailure
          containers:
          - name: kubectl
            image: bitnami/kubectl:latest
            command:
            - /bin/sh
            - -c
            - |
              echo "Scaling down services for the weekend..."
              kubectl scale deployment/api-golang --replicas=0 -n staging
              kubectl scale deployment/api-node --replicas=0 -n staging
              kubectl scale deployment/client-react --replicas=0 -n staging
              echo "Services scaled down for the weekend"

---
# Scale up on Monday morning (already covered by scale-up-weekday)

---
# RBAC: ServiceAccount for the scaler CronJobs
apiVersion: v1
kind: ServiceAccount
metadata:
  name: scaler
  namespace: staging
  labels:
    app: scaler

---
# RBAC: Role allowing the scaler to modify deployments
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: scaler
  namespace: staging
  labels:
    app: scaler
rules:
- apiGroups: ["apps"]
  resources: ["deployments", "deployments/scale"]
  verbs: ["get", "list", "patch", "update"]

---
# RBAC: RoleBinding to grant the scaler ServiceAccount the scaler Role
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: scaler
  namespace: staging
  labels:
    app: scaler
subjects:
- kind: ServiceAccount
  name: scaler
  namespace: staging
roleRef:
  kind: Role
  name: scaler
  apiGroup: rbac.authorization.k8s.io
