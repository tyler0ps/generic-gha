# Karpenter Provisioner - Cost-optimized node provisioning
# This tells Karpenter what types of nodes to create and when

apiVersion: karpenter.sh/v1alpha5
kind: Provisioner
metadata:
  name: default
spec:
  # COST OPTIMIZATION: Aggressive spot usage with ARM instances
  requirements:
    - key: "karpenter.sh/capacity-type"
      operator: In
      values: ["spot"]  # Use SPOT instances for 60-90% cost savings

    - key: "kubernetes.io/arch"
      operator: In
      values: ["arm64"]  # Graviton (ARM) = 20% cheaper than x86

    - key: "node.kubernetes.io/instance-type"
      operator: In
      values:
        - "t4g.micro"   # 2 vCPU, 1GB  RAM (~$2/month  spot)
        - "t4g.small"   # 2 vCPU, 2GB  RAM (~$4/month  spot)
        - "t4g.medium"  # 2 vCPU, 4GB  RAM (~$8/month  spot)

    - key: "topology.kubernetes.io/zone"
      operator: In
      values:
        - "ap-southeast-1a"
        - "ap-southeast-1b"

  # Limits for cost control
  limits:
    resources:
      cpu: "4"      # Max 4 vCPUs total
      memory: "16Gi"  # Max 16GB RAM total

  # Aggressive consolidation for cost savings
  ttlSecondsAfterEmpty: 30  # Delete nodes 30 seconds after they become empty
  ttlSecondsUntilExpired: 604800  # Rotate nodes after 7 days (prevents stale nodes)

  # Automatic consolidation (bin-packing)
  consolidation:
    enabled: true

  providerRef:
    name: default

---
# AWS Node Template - AWS-specific configuration for nodes
apiVersion: karpenter.k8s.aws/v1alpha1
kind: AWSNodeTemplate
metadata:
  name: default
spec:
  # Select subnets tagged for internal ELBs (private subnets)
  subnetSelector:
    kubernetes.io/role/internal-elb: "1"

  # Select security groups for EKS cluster
  securityGroupSelector:
    aws:eks:cluster-name: staging-generic-gha

  # Use cheaper EBS volumes (gp3 is newer and often cheaper than gp2)
  blockDeviceMappings:
    - deviceName: /dev/xvda
      ebs:
        volumeSize: 20Gi
        volumeType: gp3
        deleteOnTermination: true
        encrypted: true

  # User data for node initialization (optional)
  userData: |
    #!/bin/bash
    # Additional node setup if needed
    echo "Node initialized by Karpenter"

  # Tags for created instances
  tags:
    Environment: staging
    ManagedBy: Karpenter
    CostCenter: eks-staging

  # Metadata options for enhanced security
  metadataOptions:
    httpEndpoint: enabled
    httpProtocolIPv6: disabled
    httpPutResponseHopLimit: 2
    httpTokens: required  # Require IMDSv2
